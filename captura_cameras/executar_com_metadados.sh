#!/bin/bash

# Script Unificado: Download de Imagens + Extra√ß√£o de Metadados

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_color() {
    echo -e "${1}${2}${NC}"
}

clear
print_color $CYAN "
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     DOWNLOAD COMPLETO: IMAGENS + METADADOS (Vers√£o √önica)    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"

print_color $BLUE "‚ö° Este script faz TUDO em uma √∫nica execu√ß√£o:"
echo ""
print_color $GREEN "  1. üîê Login no AIVisual Dashboard"
print_color $GREEN "  2. üìπ Descoberta de TODAS as c√¢meras"
print_color $GREEN "  3. üìã Extra√ß√£o de metadados (Lugar, √Årea, IPs, etc)"
print_color $GREEN "  4. üì∏ Download de TODAS as imagens"
print_color $GREEN "  5. üíæ Salvamento de metadados em JSON"
echo ""

print_color $YELLOW "üí° Vantagens da vers√£o integrada:"
echo "   ‚Ä¢ Faz tudo em UMA √öNICA execu√ß√£o"
echo "   ‚Ä¢ N√ÉO impacta velocidade de download"
echo "   ‚Ä¢ Login apenas 1 vez (n√£o 2)"
echo "   ‚Ä¢ Mais r√°pido e eficiente"
echo ""

print_color $CYAN "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# Detectar Python
if command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
elif command -v python &> /dev/null; then
    PYTHON_CMD="python"
else
    print_color $RED "‚ùå Python n√£o encontrado!"
    exit 1
fi

print_color $GREEN "‚úì Python encontrado: $PYTHON_CMD"

# Executar
print_color $CYAN "\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
print_color $BLUE "\nüöÄ Iniciando execu√ß√£o completa..."
print_color $CYAN "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

$PYTHON_CMD camera_downloader_com_metadados.py

# Verificar resultado
if [ $? -eq 0 ]; then
    print_color $CYAN "\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    print_color $GREEN "‚úÖ EXECU√á√ÉO CONCLU√çDA COM SUCESSO!"
    print_color $CYAN "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

    echo ""
    print_color $YELLOW "üìã Arquivos gerados:"
    echo ""
    print_color $BLUE "  1. Imagens baixadas:"
    print_color $CYAN "     cameras/Nome_da_Loja/*.jpg"
    echo ""
    print_color $BLUE "  2. Metadados extra√≠dos:"
    print_color $CYAN "     data/camera_metadata.json"
    echo ""

    # Contar arquivos
    if [ -d "cameras" ]; then
        img_count=$(find cameras -name "*.jpg" -type f | wc -l)
        print_color $GREEN "     ‚úì $img_count imagens salvas"
    fi

    if [ -f "data/camera_metadata.json" ]; then
        meta_count=$(python3 -c "import json; print(len(json.load(open('data/camera_metadata.json'))))" 2>/dev/null || echo "?")
        print_color $GREEN "     ‚úì $meta_count c√¢meras com metadados"
    fi

    echo ""
    print_color $YELLOW "üìã Pr√≥ximos passos:"
    echo ""
    print_color $BLUE "  1. Visualizar metadados:"
    print_color $CYAN "     cat data/camera_metadata.json | python3 -m json.tool | less"
    echo ""
    print_color $BLUE "  2. Iniciar dashboard:"
    print_color $CYAN "     ./start_dashboard.sh"
    echo ""
    print_color $BLUE "  3. Ver no navegador:"
    print_color $CYAN "     http://localhost:5000"
    print_color $CYAN "     (Lembre-se: Ctrl+Shift+R para limpar cache)"
    echo ""
else
    print_color $RED "\n‚ùå Erro durante a execu√ß√£o"
    echo "   Verifique os logs acima"
    exit 1
fi
